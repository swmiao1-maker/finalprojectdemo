<script>
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.width = window.innerWidth;
canvas.height = window.innerHeight * 0.7;

let audioCtx, analyser, dataArray;
let micStream, micSource;
let audio, audioSource;
let audioSourceConnected = false;

let audioStartTime = null;
let staticAmount = 0;

const STATIC_FADE_IN = 0.002;
const STATIC_FADE_OUT = 0.004;

const startBtn = document.getElementById('startBtn');
const audioFileInput = document.getElementById('audioFile');
const playAudioBtn = document.getElementById('playAudioBtn');

function initAudioContext() {
    if (!audioCtx) {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 1024;
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        analyser.connect(audioCtx.destination);
    }
}

// --- Step 1: Microphone ---
startBtn.addEventListener('click', async () => {
    try {
        initAudioContext();
        micStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        micSource = audioCtx.createMediaStreamSource(micStream);
        micSource.connect(analyser);
        draw();
        audioFileInput.disabled = false;
        startBtn.disabled = true;
        alert("Microphone enabled");
    } catch (err) {
        alert("Microphone permission denied");
    }
});

// --- Step 2: Upload Audio ---
audioFileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (audio) {
        audio.pause();
        audio = null;
        audioSource.disconnect();
        audioSourceConnected = false;
    }

    audio = new Audio(URL.createObjectURL(file));
    audio.loop = true;

    initAudioContext();
    if (audioCtx.state === 'suspended') await audioCtx.resume();

    audioSource = audioCtx.createMediaElementSource(audio);
    playAudioBtn.disabled = false;
});

// --- Manual Play ---
playAudioBtn.addEventListener('click', async () => {
    if (!audio) return;
    if (audioCtx.state === 'suspended') await audioCtx.resume();

    if (!audioSourceConnected) {
        audioSource.connect(analyser);
        audioSourceConnected = true;
    }

    audioStartTime = performance.now();
    await audio.play();
    playAudioBtn.disabled = true;
});

// --- Circular Visualizer ---
function drawCircleVisualizer() {
    analyser.getByteFrequencyData(dataArray);

    const cx = canvas.width / 2;
    const cy = canvas.height / 2;
    const radius = Math.min(cx, cy) * 0.35;
    const bars = dataArray.length;

    ctx.save();
    ctx.translate(cx, cy);

    for (let i = 0; i < bars; i++) {
        const amp = dataArray[i];
        const barLength = amp * 0.7;
        const angle = (i / bars) * Math.PI * 2;

        ctx.rotate(angle);
        ctx.beginPath();
        ctx.moveTo(radius, 0);
        ctx.lineTo(radius + barLength, 0);
        ctx.strokeStyle = `hsl(${i / bars * 360}, 100%, 60%)`;
        ctx.lineWidth = 2;
        ctx.stroke();
        ctx.rotate(-angle);
    }

    ctx.restore();
}

// --- Static Overlay ---
function drawStatic() {
    const imageData = ctx.createImageData(canvas.width, canvas.height);
    const buffer = imageData.data;

    for (let i = 0; i < buffer.length; i += 4) {
        const v = Math.random() * 255;
        buffer[i] = buffer[i + 1] = buffer[i + 2] = v;
        buffer[i + 3] = staticAmount * 255;
    }
    ctx.putImageData(imageData, 0, 0);
}

// --- Main Loop ---
function draw() {
    requestAnimationFrame(draw);

    ctx.fillStyle = "rgba(0,0,0,0.25)";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    if (analyser) drawCircleVisualizer();

    // --- Static timing logic ---
    if (audio && !audio.paused && audioStartTime) {
        const elapsed = (performance.now() - audioStartTime) / 1000;
        if (elapsed > 5) {
            staticAmount += STATIC_FADE_IN;
        }
    } else {
        staticAmount -= STATIC_FADE_OUT;
    }

    staticAmount = Math.max(0, Math.min(1, staticAmount));

    if (staticAmount > 0) drawStatic();
}
</script>
